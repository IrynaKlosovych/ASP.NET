@page "/sessions/edit/{Id:int}"
@using CinemaStore.Client.Models
@using CinemaStore.Client.Models.Dto
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<h2>Редагування сеансу</h2>

@if (IsLoading)
{
    <p>Завантаження...</p>
}
else if (LoadError != null)
{
    <div class="alert alert-danger">@LoadError</div>
}
else
{
    <EditForm Model="ScreeningModel" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label>Фільм</label>
            <InputSelect @bind-Value="ScreeningModel.FilmId" class="form-control">
                @foreach (var f in Films)
                {
                    <option value="@f.FilmID">@f.Title</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => ScreeningModel.FilmId)" />
        </div>

        <div class="form-group">
            <label>Дата та час</label>
            <InputText type="datetime-local"
                       @bind-Value="ScreeningModel.StartTime"
                       class="form-control" />
            <ValidationMessage For="@(() => ScreeningModel.StartTime)" />
        </div>

        <div class="form-group">
            <label>Зал</label>
            <InputText @bind-Value="ScreeningModel.Hall" class="form-control" />
            <ValidationMessage For="@(() => ScreeningModel.Hall)" />
        </div>

        <div class="form-group form-check">
            <InputCheckbox @bind-Value="ScreeningModel.IsOver" class="form-check-input" />
            <label class="form-check-label">Сеанс завершено</label>
        </div>

        <button class="btn btn-success">Зберегти зміни</button>
        <button type="button" class="btn btn-secondary" @onclick="GoBack">Назад</button>
    </EditForm>

    @if (ErrorMessage != null)
    {
        <div class="alert alert-danger mt-3">@ErrorMessage</div>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private ScreeningCreateModel ScreeningModel = new();
    private List<FilmBindViewModel> Films = new();

    private bool IsLoading = true;
    private string? LoadError;
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Films = await Http.GetFromJsonAsync<List<FilmBindViewModel>>("api/film");

            var dto = await Http.GetFromJsonAsync<GetAllScreenings>($"api/screening/{Id}");

            if (dto == null)
            {
                LoadError = "Сеанс не знайдено.";
                return;
            }

            ScreeningModel = new ScreeningCreateModel
            {
                FilmId = dto.FilmId,
                Hall = dto.Hall,
                IsOver = dto.IsOver,
                StartTime = dto.StartTime.ToString("yyyy-MM-ddTHH:mm")
            };
        }
        catch (Exception ex)
        {
            LoadError = $"Помилка завантаження: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (!DateTime.TryParse(ScreeningModel.StartTime, out _))
        {
            ErrorMessage = "Невірний формат дати.";
            return;
        }

        ErrorMessage = null;

        var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");

        var request = new HttpRequestMessage(HttpMethod.Put, $"api/screening/{Id}")
        {
            Content = JsonContent.Create(ScreeningModel)
        };
        request.Headers.Authorization =
            new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

        var response = await Http.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            Nav.NavigateTo("/sessions");
        }
        else
        {
            var content = await response.Content.ReadAsStringAsync();
            ErrorMessage = $"Помилка при збереженні: {content}";
        }
    }

    private void GoBack() => Nav.NavigateTo("/sessions");
}
