@page "/add-admin"
@using CinemaStore.Client.Models
@using System.Text.Json
@inject HttpClient Http

<h2>Створення адміністратора</h2>

@if (!string.IsNullOrEmpty(SuccessMessage))
{
    <div class="alert alert-success">@SuccessMessage</div>
}

@if (ServerMessage?.Any() == true)
{
    <div class="alert alert-danger">
        @foreach (var msg in ServerMessage)
        {
            <div>@msg</div>
        }
    </div>
}

<EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label>Email</label>
        <InputText @bind-Value="Model.Email"
                   class="form-control"
                   autocomplete="off" />
        <ValidationMessage For="@(() => Model.Email)" />
    </div>

    <div class="form-group">
        <label>Пароль</label>
        <InputText @bind-Value="Model.Password"
                   class="form-control"
                   type="password"
                   autocomplete="new-password" />
        <ValidationMessage For="@(() => Model.Password)" />
    </div>

    <div class="form-group">
        <label>Підтвердження пароля</label>
        <InputText @bind-Value="Model.ConfirmPassword"
                   class="form-control"
                   type="password"
                   autocomplete="new-password" />
        <ValidationMessage For="@(() => Model.ConfirmPassword)" />
    </div>

    <button class="btn btn-primary">Створити адміністратора</button>
</EditForm>

@code {
    private RegisterModel Model = new();
    private List<string>? ServerMessage;
    private string? SuccessMessage;

    private async Task HandleValidSubmit()
    {
        ServerMessage = null;
        SuccessMessage = null;

        var response = await Http.PostAsJsonAsync("api/account/add-admin", Model);

        if (response.IsSuccessStatusCode)
        {
            SuccessMessage = "Адміністратора успішно створено!";
            Model = new RegisterModel();
        }
        else
        {
            var content = await response.Content.ReadAsStringAsync();
            ServerMessage = ExtractErrorMessages(content);
        }
    }

    private List<string> ExtractErrorMessages(string content)
    {
        var messages = new List<string>();

        try
        {
            using var doc = JsonDocument.Parse(content);
            var root = doc.RootElement;

            if (root.TryGetProperty("message", out var msgProp))
            {
                messages.Add(msgProp.GetString() ?? "Помилка");
                return messages;
            }

            if (root.TryGetProperty("errors", out var errorsProp))
            {
                foreach (var prop in errorsProp.EnumerateObject())
                {
                    foreach (var err in prop.Value.EnumerateArray())
                        messages.Add(err.GetString() ?? "Помилка");
                }

                if (messages.Any())
                    return messages;
            }

            foreach (var prop in root.EnumerateObject())
            {
                if (prop.Value.ValueKind == JsonValueKind.Array)
                {
                    foreach (var err in prop.Value.EnumerateArray())
                        messages.Add(err.GetString() ?? "Помилка");
                }
            }

            if (messages.Any())
                return messages;
        }
        catch
        {
        }

        if (!string.IsNullOrWhiteSpace(content))
            messages.Add(content);
        else
            messages.Add("Невідома помилка");

        return messages;
    }
}
